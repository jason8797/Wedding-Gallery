<script>
/* ===== 1. 自動偵測實際存在的圖片 ===== */
async function detectPhotos(maxCount = 300) {
  const results = [];
  const exts = ['jpg', 'png'];

  async function checkExists(url) {
    try {
      const res = await fetch(url, { method: 'HEAD' });
      return res.ok;
    } catch {
      return false;
    }
  }

  for (let i = 1; i <= maxCount; i++) {
    const num = String(i).padStart(3, '0');
    for (const ext of exts) {
      const thumb = `photos/thumb/photo${num}.${ext}`;
      const full = `photos/full/photo${num}.${ext}`;
      const exists = await checkExists(full);
      if (exists) {
        results.push({
          id: `${ext}-${num}`,
          title: `photo${num}.${ext}`,
          desc: `拍攝地點 / 小註記 ${num}`,
          thumb,
          full,
          tags: [(i % 2 === 0) ? '黑白' : '彩色']
        });
      }
    }
  }
  return results;
}

/* ===== 2. 初始化狀態 ===== */
const PHOTOS_PER_PAGE = 20;
const gallery = document.getElementById('gallery');
const totalCount = document.getElementById('totalCount');
let state = {
  items: [],
  filtered: [],
  displayed: [],
  page: 1,
  favorites: new Set(JSON.parse(localStorage.getItem('wedding_favs') || '[]'))
};

/* ===== 3. 載入並渲染 ===== */
(async function init() {
  state.items = await detectPhotos(300);
  state.filtered = state.items.slice();
  totalCount.textContent = state.items.length;
  loadNextPage();
})();

/* ===== 4. 分頁與載入 ===== */
function loadNextPage() {
  const start = (state.page - 1) * PHOTOS_PER_PAGE;
  const end = state.page * PHOTOS_PER_PAGE;
  const nextChunk = state.filtered.slice(start, end);
  if (nextChunk.length === 0) return;
  renderGallery(nextChunk, true);
  state.page++;
}

/* ===== 5. 圖片渲染（含縮圖尺寸） ===== */
function renderGallery(list, append = false) {
  if (!append) {
    gallery.innerHTML = '';
    state.page = 1;
    state.displayed = [];
  }
  list.forEach((it, i) => {
    const card = document.createElement('figure');
    card.className = 'card';
    card.dataset.index = state.displayed.length + i;

    const img = document.createElement('img');
    img.className = 'thumb';
    img.loading = 'lazy';
    img.alt = it.title;
    img.src = it.thumb;
    img.width = 300;       // ✅ 限制寬度為 300px
    img.style.height = 'auto'; // 等比例縮放

    const cap = document.createElement('figcaption');
    cap.className = 'caption';
    cap.innerHTML = `<div style="font-weight:600">${it.title}</div>
                     <div style="font-size:12px;color:var(--muted)">${it.desc}</div>`;

    const heart = document.createElement('div');
    heart.className = 'heart';
    heart.innerHTML = state.favorites.has(it.id) ? '♥' : '♡';
    heart.addEventListener('click', e => {
      e.stopPropagation();
      toggleFav(it.id, heart);
    });

    card.append(img, cap, heart);
    card.addEventListener('click', () => openModal(card.dataset.index));
    gallery.appendChild(card);
  });
  state.displayed = append ? state.displayed.concat(list) : list.slice();
}

/* ===== 6. Infinite Scroll ===== */
window.addEventListener('scroll', () => {
  const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
  if (scrollTop + clientHeight >= scrollHeight - 200) {
    loadNextPage();
  }
});

/* ===== 7. 收藏功能 ===== */
function toggleFav(id, el) {
  if (state.favorites.has(id)) {
    state.favorites.delete(id);
    el.innerHTML = '♡';
  } else {
    state.favorites.add(id);
    el.innerHTML = '♥';
  }
  localStorage.setItem('wedding_favs', JSON.stringify([...state.favorites]));
}

/* ===== 8. Modal ===== */
function openModal(index) {
  const modal = document.getElementById('modal');
  const modalImg = document.getElementById('modalImg');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalIndex = document.getElementById('modalIndex');
  const it = state.filtered[index];
  if (!it) return;
  modalImg.src = it.full;
  modalTitle.textContent = it.title;
  modalDesc.textContent = it.desc;
  modalIndex.textContent = `${index + 1} / ${state.filtered.length}`;
  modal.classList.add('open');
}

/* ===== 9. 關閉 Modal ===== */
document.getElementById('closeBtn').onclick = () => {
  document.getElementById('modal').classList.remove('open');
};
</script>
