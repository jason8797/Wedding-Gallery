import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Heart, Search, Shuffle, ChevronLeft, ChevronRight } from 'lucide-react';

const PHOTOS_PER_PAGE = 20;

export default function WeddingGallery() {
  const [photos, setPhotos] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [page, setPage] = useState(1);
  const [filteredPhotos, setFilteredPhotos] = useState([]);

  // 初始化讀取 jpg 與 png
  useEffect(() => {
    const items = [];
    for (let i = 1; i <= 150; i++) {
      const num = i.toString().padStart(3, '0');
      items.push({
        id: `jpg-${num}`,
        thumb: `/photos/thumb/photo${num}.jpg`,
        full: `/photos/full/photo${num}.jpg`,
      });
      items.push({
        id: `png-${num}`,
        thumb: `/photos/thumb/photo${num}.png`,
        full: `/photos/full/photo${num}.png`,
      });
    }
    setPhotos(items);
  }, []);

  // 搜尋與篩選
  useEffect(() => {
    const filtered = photos.filter(
      (p) => p.full.toLowerCase().includes(searchTerm.toLowerCase())
    );
    setFilteredPhotos(filtered);
  }, [photos, searchTerm]);

  // 分頁邏輯
  const totalPages = Math.ceil(filteredPhotos.length / PHOTOS_PER_PAGE);
  const displayedPhotos = filteredPhotos.slice(
    (page - 1) * PHOTOS_PER_PAGE,
    page * PHOTOS_PER_PAGE
  );

  // 收藏功能
  const toggleFavorite = (id) => {
    setFavorites((prev) =>
      prev.includes(id) ? prev.filter((f) => f !== id) : [...prev, id]
    );
  };

  // 隨機排列
  const shufflePhotos = () => {
    setFilteredPhotos((prev) => [...prev].sort(() => Math.random() - 0.5));
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-100 via-white to-blue-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-3xl font-bold text-gray-700">💍 Wedding Gallery</h1>
          <div className="flex gap-2">
            <input
              type="text"
              placeholder="搜尋照片..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="border border-gray-300 rounded-xl px-3 py-2"
            />
            <Button onClick={shufflePhotos} variant="outline">
              <Shuffle className="w-4 h-4 mr-1" /> 隨機排列
            </Button>
          </div>
        </div>

        {/* 瀑布流相簿 */}
        <motion.div layout className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {displayedPhotos.map((photo) => (
            <Card
              key={photo.id}
              className="overflow-hidden shadow-lg relative group hover:scale-105 transition-transform"
            >
              <img
                src={photo.thumb}
                alt={photo.id}
                loading="lazy"
                className="w-full h-48 object-cover"
              />
              <button
                onClick={() => toggleFavorite(photo.id)}
                className="absolute top-2 right-2 bg-white/80 rounded-full p-1"
              >
                <Heart
                  className={`w-5 h-5 transition-colors ${
                    favorites.includes(photo.id)
                      ? 'text-red-500 fill-red-500'
                      : 'text-gray-400'
                  }`}
                />
              </button>
            </Card>
          ))}
        </motion.div>

        {/* 分頁按鈕 */}
        <div className="flex justify-center items-center gap-4 mt-8">
          <Button
            onClick={() => setPage((p) => Math.max(p - 1, 1))}
            disabled={page === 1}
          >
            <ChevronLeft className="w-4 h-4" /> 上一頁
          </Button>
          <span className="text-gray-600">
            第 {page} / {totalPages} 頁
          </span>
          <Button
            onClick={() => setPage((p) => Math.min(p + 1, totalPages))}
            disabled={page === totalPages}
          >
            下一頁 <ChevronRight className="w-4 h-4" />
          </Button>
        </div>
      </div>
    </div>
  );
}
